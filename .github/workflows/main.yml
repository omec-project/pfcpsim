# SPDX-License-Identifier: Apache-2.0
# Copyright 2022 Open Networking Foundation

name: Build PFCPsim
on: [push, pull_request]
jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      DOCKER_REPO: "opennetworking/pfcpsim"
    steps:
      - name: Checkout this repository
        uses: actions/checkout@v2

      - name: version to env variable
        run: |
          VER=$(cat VERSION)
          echo "VERSION=$VER" >> $GITHUB_ENV

      - name: Build and export to Docker for testing.
        uses: docker/build-push-action@v2
        with:
          context: .
          push: false
          load: true # load the built image to local docker instance. Needed for testing step.
          build-args: |
            "PROTOBUF_VERSION=${{ matrix.PROTOBUF_VERSION }}"
          tags: "${{ env.DOCKER_REPO }}:pfcpsim-client-${{ env.VERSION }}" # Local Runtime image
          target: "pfcpsim-client"

        - name: Test docker build
          run: |
            docker run --rm ${{ env.DOCKER_REPO }}:pfcpsim-client-${{ env.VERSION }} pfcpsim-client --help
